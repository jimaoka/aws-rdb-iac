name: Terraform Apply

on:
  push:
    branches: [main]

concurrency:
  group: terraform-apply
  cancel-in-progress: false

permissions:
  id-token: write
  contents: read

jobs:
  detect-targets:
    runs-on: ubuntu-latest
    outputs:
      modified: ${{ steps.result.outputs.modified }}
      deleted: ${{ steps.result.outputs.deleted }}
      has_modified: ${{ steps.result.outputs.has_modified }}
      has_deleted: ${{ steps.result.outputs.has_deleted }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find merged PR and parse labels
        id: labels
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Find the PR associated with this merge commit
          PR_NUMBER=$(gh api "/repos/${{ github.repository }}/commits/${{ github.sha }}/pulls" --jq '.[0].number // empty')
          if [[ -n "${PR_NUMBER}" ]]; then
            echo "Found PR #${PR_NUMBER}"
            LABELS_JSON=$(gh pr view "${PR_NUMBER}" --repo "${{ github.repository }}" --json labels --jq '[.labels[].name]')
            .github/scripts/parse-labels.sh "${LABELS_JSON}"
          else
            echo "No associated PR found â€” skipping label-based detection"
            echo "has_labels=false" >> "${GITHUB_OUTPUT}"
          fi

      - name: Fallback to detect-changes
        id: detect
        if: steps.labels.outputs.has_labels != 'true'
        run: .github/scripts/detect-changes.sh "${{ github.event.before }}" "${{ github.sha }}"

      - name: Set outputs
        id: result
        run: |
          if [[ "${{ steps.labels.outputs.has_labels }}" == "true" ]]; then
            echo "modified=${{ steps.labels.outputs.modified }}" >> "${GITHUB_OUTPUT}"
            echo "deleted=${{ steps.labels.outputs.deleted }}" >> "${GITHUB_OUTPUT}"
            echo "has_modified=${{ steps.labels.outputs.has_modified }}" >> "${GITHUB_OUTPUT}"
            echo "has_deleted=${{ steps.labels.outputs.has_deleted }}" >> "${GITHUB_OUTPUT}"
          else
            echo "modified=${{ steps.detect.outputs.modified }}" >> "${GITHUB_OUTPUT}"
            echo "deleted=${{ steps.detect.outputs.deleted }}" >> "${GITHUB_OUTPUT}"
            echo "has_modified=${{ steps.detect.outputs.has_modified }}" >> "${GITHUB_OUTPUT}"
            echo "has_deleted=${{ steps.detect.outputs.has_deleted }}" >> "${GITHUB_OUTPUT}"
          fi

  destroy:
    needs: detect-targets
    if: needs.detect-targets.outputs.has_deleted == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        dir: ${{ fromJson(needs.detect-targets.outputs.deleted) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Restore deleted directory
        run: git checkout "${{ github.event.before }}" -- "${{ matrix.dir }}/"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ap-northeast-1

      - name: Setup Terragrunt
        uses: ./.github/actions/setup-terragrunt

      - name: Terragrunt Init
        working-directory: ${{ matrix.dir }}
        run: terragrunt init --terragrunt-non-interactive -input=false

      - name: Terragrunt Destroy
        working-directory: ${{ matrix.dir }}
        run: terragrunt destroy --terragrunt-non-interactive -auto-approve -input=false

  apply:
    needs: [detect-targets, destroy]
    if: |
      always() &&
      needs.detect-targets.outputs.has_modified == 'true' &&
      needs.destroy.result != 'failure'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        dir: ${{ fromJson(needs.detect-targets.outputs.modified) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ap-northeast-1

      - name: Setup Terragrunt
        uses: ./.github/actions/setup-terragrunt

      - name: Terragrunt Init
        working-directory: ${{ matrix.dir }}
        run: terragrunt init --terragrunt-non-interactive -input=false

      - name: Terragrunt Apply
        working-directory: ${{ matrix.dir }}
        run: terragrunt apply --terragrunt-non-interactive -auto-approve -input=false
