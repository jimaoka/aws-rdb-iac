name: Terraform Plan

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, labeled]

concurrency:
  group: terraform-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  id-token: write
  contents: write
  pull-requests: write

jobs:
  detect-targets:
    runs-on: ubuntu-latest
    outputs:
      modified: ${{ steps.result.outputs.modified }}
      deleted: ${{ steps.result.outputs.deleted }}
      has_modified: ${{ steps.result.outputs.has_modified }}
      has_deleted: ${{ steps.result.outputs.has_deleted }}
      is_labeled: ${{ steps.labels.outputs.has_labels }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Parse PR labels
        id: labels
        run: |
          LABELS_JSON=$(gh pr view "${{ github.event.pull_request.number }}" --repo "${{ github.repository }}" --json labels --jq '[.labels[].name]')
          .github/scripts/parse-labels.sh "${LABELS_JSON}"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Fallback to detect-changes
        id: detect
        if: steps.labels.outputs.has_labels != 'true'
        run: .github/scripts/detect-changes.sh "${{ github.event.pull_request.base.sha }}" "${{ github.event.pull_request.head.sha }}"

      - name: Set outputs
        id: result
        run: |
          if [[ "${{ steps.labels.outputs.has_labels }}" == "true" ]]; then
            echo "modified=${{ steps.labels.outputs.modified }}" >> "${GITHUB_OUTPUT}"
            echo "deleted=${{ steps.labels.outputs.deleted }}" >> "${GITHUB_OUTPUT}"
            echo "has_modified=${{ steps.labels.outputs.has_modified }}" >> "${GITHUB_OUTPUT}"
            echo "has_deleted=${{ steps.labels.outputs.has_deleted }}" >> "${GITHUB_OUTPUT}"
          else
            echo "modified=${{ steps.detect.outputs.modified }}" >> "${GITHUB_OUTPUT}"
            echo "deleted=${{ steps.detect.outputs.deleted }}" >> "${GITHUB_OUTPUT}"
            echo "has_modified=${{ steps.detect.outputs.has_modified }}" >> "${GITHUB_OUTPUT}"
            echo "has_deleted=${{ steps.detect.outputs.has_deleted }}" >> "${GITHUB_OUTPUT}"
          fi

  plan:
    needs: detect-targets
    if: needs.detect-targets.outputs.has_modified == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        dir: ${{ fromJson(needs.detect-targets.outputs.modified) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ap-northeast-1

      - name: Setup Terragrunt
        uses: ./.github/actions/setup-terragrunt

      - name: Terragrunt Init
        working-directory: ${{ matrix.dir }}
        run: terragrunt init --terragrunt-non-interactive -input=false

      - name: Terragrunt Validate
        working-directory: ${{ matrix.dir }}
        run: terragrunt validate --terragrunt-non-interactive

      - name: Terragrunt Plan
        id: plan
        working-directory: ${{ matrix.dir }}
        run: |
          set -o pipefail
          terragrunt plan --terragrunt-non-interactive --terragrunt-no-color -input=false -no-color 2>&1 | tee plan_raw.txt
          echo "exitcode=${PIPESTATUS[0]}" >> "${GITHUB_OUTPUT}"

      - name: Strip ANSI codes
        if: always()
        working-directory: ${{ matrix.dir }}
        run: sed 's/\x1b\[[0-9;]*m//g' plan_raw.txt > plan_output.txt

      - name: Post plan to PR
        if: always()
        uses: actions/github-script@v7
        env:
          DIR: ${{ matrix.dir }}
        with:
          script: |
            const fs = require('fs');
            const dir = process.env.DIR;
            const marker = `<!-- terraform-plan: ${dir} -->`;
            let output = '';
            try {
              output = fs.readFileSync(`${dir}/plan_output.txt`, 'utf8');
            } catch {
              output = 'Plan output not available.';
            }

            // Truncate if too long for GitHub comment (max ~65536 chars)
            const maxLen = 60000;
            if (output.length > maxLen) {
              output = output.substring(0, maxLen) + '\n... (truncated)';
            }

            const body = `${marker}
            ### Plan: \`${dir}\`

            <details><summary>Show plan output</summary>

            \`\`\`
            ${output}
            \`\`\`

            </details>`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.find(c => c.body.includes(marker));
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

  plan-destroy:
    needs: detect-targets
    if: needs.detect-targets.outputs.has_deleted == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        dir: ${{ fromJson(needs.detect-targets.outputs.deleted) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Restore deleted directory
        run: git checkout "${{ github.event.pull_request.base.sha }}" -- "${{ matrix.dir }}/"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: ap-northeast-1

      - name: Setup Terragrunt
        uses: ./.github/actions/setup-terragrunt

      - name: Terragrunt Init
        working-directory: ${{ matrix.dir }}
        run: terragrunt init --terragrunt-non-interactive -input=false

      - name: Terragrunt Plan Destroy
        id: plan
        working-directory: ${{ matrix.dir }}
        run: |
          set -o pipefail
          terragrunt plan --terragrunt-non-interactive --terragrunt-no-color -destroy -input=false -no-color 2>&1 | tee plan_raw.txt
          echo "exitcode=${PIPESTATUS[0]}" >> "${GITHUB_OUTPUT}"

      - name: Strip ANSI codes
        if: always()
        working-directory: ${{ matrix.dir }}
        run: sed 's/\x1b\[[0-9;]*m//g' plan_raw.txt > plan_output.txt

      - name: Post destroy plan to PR
        if: always()
        uses: actions/github-script@v7
        env:
          DIR: ${{ matrix.dir }}
        with:
          script: |
            const fs = require('fs');
            const dir = process.env.DIR;
            const marker = `<!-- terraform-plan: ${dir} -->`;
            let output = '';
            try {
              output = fs.readFileSync(`${dir}/plan_output.txt`, 'utf8');
            } catch {
              output = 'Plan output not available.';
            }

            const maxLen = 60000;
            if (output.length > maxLen) {
              output = output.substring(0, maxLen) + '\n... (truncated)';
            }

            const body = `${marker}
            ### :warning: Destroy Plan: \`${dir}\`

            > **This directory has been deleted. Merging will destroy all resources.**

            <details><summary>Show destroy plan output</summary>

            \`\`\`
            ${output}
            \`\`\`

            </details>`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.find(c => c.body.includes(marker));
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

  summary:
    needs: [detect-targets, plan, plan-destroy]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check job results
        run: |
          results=("${{ needs.detect-targets.result }}" "${{ needs.plan.result }}" "${{ needs.plan-destroy.result }}")
          for result in "${results[@]}"; do
            if [[ "${result}" == "failure" ]]; then
              echo "::error::One or more jobs failed"
              exit 1
            fi
          done
          echo "All jobs passed successfully"

  auto-merge:
    needs: [detect-targets, summary]
    if: >-
      always() &&
      needs.summary.result == 'success' &&
      needs.detect-targets.outputs.is_labeled == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Auto-merge
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr merge ${{ github.event.pull_request.number }} \
            --repo ${{ github.repository }} \
            --squash --auto
